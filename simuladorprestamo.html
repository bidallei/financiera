<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Simulador de Préstamos - Financiera</title>
<style>
  body {
    font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
    background: #f5f7fa;
    margin: 0; padding: 0;
    display: flex; flex-direction: column; align-items: center;
    min-height: 100vh;
  }
  h1 {
    color: #1976d2;
    margin-top: 1rem;
  }
  form {
    background: white;
    padding: 1.5rem 2rem;
    border-radius: 8px;
    box-shadow: 0 2px 8px rgb(0 0 0 / 0.15);
    margin-top: 1rem;
    width: 320px;
  }
  label {
    display: block;
    margin-top: 1rem;
    font-weight: 600;
    color: #333;
  }
  select, input[type=number] {
    width: 100%;
    margin-top: 0.3rem;
    padding: 0.5rem;
    font-size: 1rem;
    border: 1px solid #bbb;
    border-radius: 4px;
    box-sizing: border-box;
  }
  button {
    margin-top: 1.5rem;
    width: 100%;
    background: #1976d2;
    border: none;
    color: white;
    font-size: 1.1rem;
    padding: 0.75rem;
    border-radius: 5px;
    cursor: pointer;
    transition: background-color 0.3s ease;
  }
  button:hover {
    background: #135ba1;
  }
  #resultado {
    margin-top: 2rem;
    width: 90%;
    max-width: 800px;
    background: white;
    padding: 1rem;
    border-radius: 8px;
    box-shadow: 0 2px 12px rgb(0 0 0 / 0.1);
    overflow-x: auto;
  }
  table {
    width: 100%;
    border-collapse: collapse;
    margin-top: 1rem;
  }
  th, td {
    border: 1px solid #ddd;
    padding: 8px;
    text-align: right;
  }
  th {
    background-color: #1976d2;
    color: white;
  }
  td:first-child, th:first-child {
    text-align: center;
  }
  .botones-export {
    margin-top: 1rem;
    display: flex;
    gap: 1rem;
    justify-content: center;
    flex-wrap: wrap;
  }
  .botones-export button {
    width: auto;
    padding: 0.5rem 1.2rem;
  }
</style>

<!-- Librerías para exportar Excel -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
<!-- Librerías para PDF -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.25/jspdf.plugin.autotable.min.js"></script>
</head>
<body>

<h1>Simulador de Préstamos</h1>

<form id="simuladorForm" onsubmit="event.preventDefault(); generarSimulacion();">
  <label for="monto">Monto solicitado (pesos):</label>
  <select id="monto" required>
    <option value="">Selecciona un monto</option>
    <option value="5000">$5,000</option>
    <option value="6000">$6,000</option>
    <option value="7000">$7,000</option>
    <option value="8000">$8,000</option>
    <option value="9000">$9,000</option>
    <option value="10000">$10,000</option>
    <option value="11000">$11,000</option>
    <option value="12000">$12,000</option>
    <option value="13000">$13,000</option>
    <option value="14000">$14,000</option>
    <option value="15000">$15,000</option>
    <option value="16000">$16,000</option>
    <option value="17000">$17,000</option>
    <option value="18000">$18,000</option>
    <option value="19000">$19,000</option>
    <option value="20000">$20,000</option>
    <option value="21000">$21,000</option>
    <option value="22000">$22,000</option>
    <option value="23000">$23,000</option>
    <option value="24000">$24,000</option>
    <option value="25000">$25,000</option>
    <option value="26000">$26,000</option>
    <option value="27000">$27,000</option>
    <option value="28000">$28,000</option>
    <option value="29000">$29,000</option>
    <option value="30000">$30,000</option>
  </select>

  <label for="semanas">Semanas:</label>
  <select id="semanas" required>
    <option value="">Selecciona semanas</option>
    <!-- 1 a 40 -->
    <script>
      for(let i=1; i<=40; i++){
        document.write(`<option value="${i}">${i}</option>`);
      }
    </script>
  </select>

  <button type="submit">Calcular</button>
</form>

<div id="resultado"></div>

<div class="botones-export" style="display:none;" id="botonesExport">
  <button onclick="exportarExcel()">Exportar Excel</button>
  <button onclick="exportarPDFdesdeDatos()">Exportar PDF</button>
</div>

<script>
function generarSimulacion() {
  const monto = parseInt(document.getElementById('monto').value);
  const semanas = parseInt(document.getElementById('semanas').value);

  if (!monto || !semanas) {
    alert('Por favor selecciona monto y semanas.');
    return;
  }

  // Cálculo proporcional:
  // base: 10000 en 21 semanas => 15000 total
  const tasaProporcional = 0.5;
  const factorPago = 1 + (semanas / 21) * tasaProporcional;
  const totalPagar = monto * factorPago;

  // Pago semanal (redondeado a 10 pesos)
  const pagoSemanal = Math.floor(totalPagar / semanas / 10) * 10;
  // Ajuste para último pago (para no pasarnos)
  const pagoFinal = totalPagar - pagoSemanal * (semanas - 1);

  let html = `<h2>Resultado de simulación</h2>`;
  html += `<p><strong>Monto solicitado:</strong> $${monto.toLocaleString()}</p>`;
  html += `<p><strong>Semanas:</strong> ${semanas}</p>`;
  html += `<p><strong>Total a pagar:</strong> $${totalPagar.toFixed(2)}</p>`;

  html += `<table><thead><tr><th>Semana</th><th>Pago semanal (MXN)</th><th>Pago acumulado (MXN)</th></tr></thead><tbody>`;

  let acumulado = 0;
  for(let i=1; i<=semanas; i++) {
    const pago = (i === semanas) ? pagoFinal : pagoSemanal;
    acumulado += pago;
    html += `<tr><td>${i}</td><td>${pago.toFixed(2)}</td><td>${acumulado.toFixed(2)}</td></tr>`;
  }
  html += `</tbody></table>`;

  document.getElementById('resultado').innerHTML = html;
  document.getElementById('botonesExport').style.display = 'flex';
}

// Exportar a Excel
function exportarExcel() {
  const monto = parseInt(document.getElementById('monto').value);
  const semanas = parseInt(document.getElementById('semanas').value);
  if (!monto || !semanas) {
    alert('Primero genera una simulación.');
    return;
  }

  // Recalcular datos
  const tasaProporcional = 0.5;
  const factorPago = 1 + (semanas / 21) * tasaProporcional;
  const totalPagar = monto * factorPago;

  const pagoSemanal = Math.floor(totalPagar / semanas / 10) * 10;
  const pagoFinal = totalPagar - pagoSemanal * (semanas - 1);

  const filas = [];
  let acumulado = 0;
  for(let i=1; i<=semanas; i++) {
    const pago = (i === semanas) ? pagoFinal : pagoSemanal;
    acumulado += pago;
    filas.push({ Semana: i, 'Pago semanal': pago.toFixed(2), 'Pago acumulado': acumulado.toFixed(2) });
  }

  // Crear libro y hoja
  const wb = XLSX.utils.book_new();
  const wsData = [
    ['Simulación de préstamo'],
    [`Monto solicitado: $${monto}`],
    [`Semanas: ${semanas}`],
    [`Total a pagar: $${totalPagar.toFixed(2)}`],
    [],
    ['Semana', 'Pago semanal (MXN)', 'Pago acumulado (MXN)'],
  ];

  filas.forEach(f => {
    wsData.push([f.Semia, f['Pago semanal'], f['Pago acumulado']]);
  });

  const ws = XLSX.utils.aoa_to_sheet(wsData);
  XLSX.utils.book_append_sheet(wb, ws, 'Simulación');

  XLSX.writeFile(wb, 'simulacion_prestamo.xlsx');
}

// Exportar PDF con jsPDF y autoTable
function exportarPDFdesdeDatos() {
  if (!window.jspdf || !window.jspdf.jsPDF) {
    alert("La librería jsPDF no está cargada.");
    return;
  }

  const monto = parseInt(document.getElementById('monto').value);
  const semanas = parseInt(document.getElementById('semanas').value);

  if (!monto || !semanas) {
    alert("Primero genera una simulación.");
    return;
  }

  const { jsPDF } = window.jspdf;

  const tasaProporcional = 0.5;
  const factorPago = 1 + (semanas / 21) * tasaProporcional;
  const totalPagar = monto * factorPago;

  const pagoSemanal = Math.floor(totalPagar / semanas / 10) * 10;
  const pagoFinal = totalPagar - (pagoSemanal * (semanas - 1));

  const filas = [];
  let acumulado = 0;
  for (let i = 1; i <= semanas; i++) {
    const pago = (i === semanas) ? pagoFinal : pagoSemanal;
    acumulado += pago;
    filas.push([i.toString(), pago.toFixed(2), acumulado.toFixed(2)]);
  }

  const doc = new jsPDF();

  doc.setFontSize(16);
  doc.text("Simulador de Préstamos", 14, 20);
  doc.setFontSize(12);
  doc.text(`Monto solicitado: $${monto}`, 14, 30);
  doc.text(`Semanas: ${semanas}`, 14, 36);
  doc.text(`Total a pagar: $${totalPagar.toFixed(2)}`, 14, 42);

  doc.autoTable({
    startY: 50,
    head: [['Semana', 'Pago semanal', 'Total acumulado']],
    body: filas,
    theme: 'striped',
    headStyles: { fillColor: [25, 118, 210] },
    styles: { cellPadding: 3, fontSize: 10 }
  });

  doc.save("simulacion.pdf");
}
</script>

</body>
</html>
